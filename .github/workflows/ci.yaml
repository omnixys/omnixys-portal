# @license GPL-3.0-or-later
# Copyright (C) 2025 Caleb Gyamfi - Omnixys Technologies
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# For more information, visit <https://www.gnu.org/licenses/>.
#
# Omnixys Workflow Suite â€“ ci.yml
# Purpose: Continuous Integration pipeline for all pushes and pull requests.
# Language: Node / TypeScript (pnpm)

name: Continuous Integration â€“ Omnixys

on:
  push:
    branches:
      - main
      - '!release'
  pull_request:
    branches:
      - '**'
      - '!release'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  OMNIXYS_ADMIN_USERNAME: ${{ secrets.OMNIXYS_ADMIN_USERNAME }}
  OMNIXYS_ADMIN_PASSWORD: ${{ secrets.OMNIXYS_ADMIN_PASSWORD }}
  OMNIXYS_USER_USERNAME: ${{ secrets.OMNIXYS_USER_USERNAME }}
  OMNIXYS_USER_PASSWORD: ${{ secrets.OMNIXYS_USER_PASSWORD }}
  OMNIXYS_EMAIL_DOMAIN: ${{ secrets.OMNIXYS_EMAIL_DOMAIN }}

  POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
  POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
  POSTGRES_SQL_HOST: postgres://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5433/${{ secrets.POSTGRES_DB }}

  KAFKA_BROKER: ${{ secrets.KAFKA_BROKER }}
  TEMPO_URI: ${{ secrets.TEMPO_URI }}

  KC_DB_PASSWORD: ${{ secrets.KC_DB_PASSWORD }}
  KC_ADMIN_USERNAME: ${{ secrets.KC_ADMIN_USERNAME }}
  KC_ADMIN_PASSWORD: ${{ secrets.KC_ADMIN_PASSWORD }}
  KC_URL: ${{ secrets.KC_TEST_URL }}
  KC_REALM: ${{ secrets.KC_REALM }}
  KC_CLIENT_ID: ${{ secrets.KC_CLIENT_ID }}
  KC_CLIENT_SECRET: ${{ secrets.KC_CLIENT_SECRET }}

  KEYS_PATH: ${{ secrets.KEYS_PATH }}
  SERVICE: ${{ secrets.SERVICE }}
  PORT: ${{ secrets.PORT }}
  GRAPHQL_PLAYGROUND: ${{ secrets.GRAPHQL_PLAYGROUND }}
  HTTPS: ${{ secrets.HTTPS }}

  LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
  LOG_PRETTY: ${{ secrets.LOG_PRETTY }}
  LOG_DEFAULT: ${{ secrets.LOG_DEFAULT }}
  LOG_DIRECTORY: ${{ secrets.LOG_DIRECTORY }}
  LOG_FILE_DEFAULT_NAME: ${{ secrets.LOG_FILE_DEFAULT_NAME }}

  VALKEY_PASSWORD: ${{ secrets.VALKEY_PASSWORD }}

  POSTGRES_TEST_USER: ${{ secrets.POSTGRES_TEST_USER }}
  POSTGRES_TEST_PASSWORD: ${{ secrets.POSTGRES_TEST_PASSWORD }}
  POSTGRES_TEST_DB: ${{ secrets.POSTGRES_TEST_DB }}
  POSTGRES_TEST_URL: postgres://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5433/${{ secrets.POSTGRES_DB }}

  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  SHADOW_DATABASE_URL: ${{ secrets.SHADOW_DATABASE_URL }}
  
jobs:
  ci:
    name: Run Lint, Build, Test, and Typecheck
    runs-on: ubuntu-latest
    if: >
      !contains(github.event.head_commit.message, 'chore(version)') &&
      !contains(github.event.head_commit.message, 'docs(changelog)')

    strategy:
      matrix:
        node-version: [24.10.0]

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Enable Corepack (pnpm)
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: âš™ï¸ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: â™»ï¸ Restore pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # - name: ğŸ” Lint check
      #   run: pnpm lint

      - name: ğŸ§± Build project
        run: pnpm build
        env:
          NODE_ENV: production

      # - name: ğŸ§ª Run tests
      #   run: pnpm t

      # - name: ğŸ”¤ Typecheck
      #   run: npx tsc

      # - name: ğŸ“Š Upload coverage to Codecov
      #   if: success()
      #   uses: codecov/codecov-action@v4
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     files: ./__tests__/reports/e2e/coverage/lcov.info
      #     flags: unittests
      #     fail_ci_if_error: false
